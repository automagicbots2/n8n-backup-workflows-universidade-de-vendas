{
  "active": true,
  "connections": {
    "consulta_sdr": {
      "main": [
        [
          {
            "node": "create/update clint4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_url_rotacionamento_colaboradores": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_users": {
      "main": [
        [
          {
            "node": "cria_atualiza_user",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria_atualiza_user": {
      "main": [
        [
          {
            "node": "consulta_sdr",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_funil": {
      "main": [
        [
          {
            "node": "pesquisa_url_rotacionamento_colaboradores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_funis": {
      "main": [
        [
          {
            "node": "busca_funil",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "infos_bc": {
      "main": [
        [
          {
            "node": "avisa_Natalia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formata_dados1": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_funis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formata_dados": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_funis1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "consulta_sdr1": {
      "main": [
        [
          {
            "node": "create/update clint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_url_rotacionamento_colaboradores1": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_users1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_users1": {
      "main": [
        [
          {
            "node": "cria_atualiza_user1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria_atualiza_user1": {
      "main": [
        [
          {
            "node": "consulta_sdr1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_funil1": {
      "main": [
        [
          {
            "node": "pesquisa_url_rotacionamento_colaboradores1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_funis1": {
      "main": [
        [
          {
            "node": "busca_funil1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Popup-InCompany": {
      "main": [
        [
          {
            "node": "formata_dados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "create/update clint": {
      "main": [
        [
          {
            "node": "infos_bc",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "typeform-InCompany1": {
      "main": [
        [
          {
            "node": "formata_dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-10-01T13:22:27.919Z",
  "id": "F9oQ5dYryPzzyqTQ",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "⌚[Fabricio Nunes][Indicação] - Trata dados",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Capturar os dados do input\nconst inputData = items[0].json.body;\n\n// Função para capitalizar o nome\nfunction capitalizeName(fullName) {\n    if (!fullName) {\n        return { fname: '', lname: '', fullname: '' };\n    }\n\n    const lowerCaseWords = ['da', 'de', 'do', 'di', 'du'];\n    let words = fullName.toLowerCase().split(' ').map((word, index) => {\n        if (lowerCaseWords.includes(word) && index !== 0) {\n            return word;\n        }\n        return word.charAt(0).toUpperCase() + word.slice(1);\n    });\n\n    let fname = words.shift();\n    let lname = words.join(' ');\n\n    return { fname, lname, fullname: `${fname} ${lname}` };\n}\n\n// Função para formatar email\nfunction formatEmail(email) {\n    return email ? email.toLowerCase().trim() : \"\";\n}\n\n// Função para processar e formatar o telefone\nfunction processTelefone(telefoneOriginal) {\n    if (!telefoneOriginal) return \"\";\n    const telefoneLimpo = telefoneOriginal.replace(/\\D/g, \"\"); // Remove caracteres não numéricos\n    const DDI = '55';\n    const DDD = telefoneLimpo.slice(0, 2);\n    let numero;\n\n    if (parseInt(DDD) > 28) {\n        numero = telefoneLimpo.slice(-8);\n    } else {\n        numero = telefoneLimpo.slice(-9);\n    }\n\n    return `${DDI}${DDD}${numero}`;\n}\n\n// Extrair e formatar os dados\nconst fullNameAnswer = inputData[\"name\"] || \"\";\nconst emailAnswer = inputData[\"email\"] || \"\";\nconst telefoneClienteOriginal = inputData[\"phone\"] || \"\";\nconst telefoneFinal = processTelefone(telefoneClienteOriginal);\n\nconst formattedNames = capitalizeName(fullNameAnswer);\nconst formattedEmail = formatEmail(emailAnswer);\n\n// Capturar UTMs e outros campos\nconst utm_source = inputData[\"utm_source\"] || \"\";\nconst utm_campaign = inputData[\"utm_campaign\"] || \"\";\nconst utm_medium = inputData[\"utm_medium\"] || \"\";\nconst utm_term = inputData[\"utm_term\"] || \"\";\nconst utm_content = inputData[\"utm_content\"] || \"\";\nconst form_id = inputData[\"popup_id\"] || \"\";\nconst form_name = inputData[\"form_name\"] || \"\";\nconst data_envio = inputData[\"timestamp\"] || \"\";\nconst horario_envio = inputData[\"Horário\"] || \"\";\nconst url_pagina = inputData[\"origin\"] || \"\";\n\n// Montar o objeto de resultado\nconst result = {\n    ...formattedNames, // Nome formatado\n    email: formattedEmail, // Email formatado\n    whatsapp: telefoneFinal, // WhatsApp formatado\n    utm_source: utm_source,\n    utm_campaign: utm_campaign,\n    utm_term: utm_term,\n    utm_medium: utm_medium,\n    utm_content: utm_content,\n    form_id: form_id,\n    form_name: form_name,\n    data_envio: data_envio,\n    horario_envio: horario_envio,\n    url_pagina: url_pagina\n};\n\n// Retorna o resultado como esperado pelo n8n\nreturn [{ json: result }];\n"
      },
      "id": "d8e00f3f-6385-4fbd-b22e-73b450637fe2",
      "name": "formata_dados1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        740,
        280
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://functions-api.clint.digital/endpoints/integration/webhook/60637b72-8f93-4644-a92e-fc5416ce917c",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados1\"].json[\"fname\"] }} {{ $node[\"formata_dados1\"].json[\"lname\"] }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados1\"].json[\"whatsapp\"] }}"
            },
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados1\"].json[\"email\"] }}"
            },
            {
              "name": "utm_source",
              "value": "={{ $node[\"formata_dados1\"].json[\"utm_source\"] }}"
            },
            {
              "name": "utm_campaign",
              "value": "={{ $node[\"formata_dados1\"].json[\"utm_campaign\"] }}"
            },
            {
              "name": "utm_term",
              "value": "={{ $node[\"formata_dados1\"].json[\"utm_term\"] }}"
            },
            {
              "name": "utm_medium",
              "value": "={{ $node[\"formata_dados1\"].json[\"utm_medium\"] }}"
            },
            {
              "name": "utm_content",
              "value": "={{ $node[\"formata_dados1\"].json[\"utm_content\"] }}"
            },
            {
              "name": "funil",
              "value": "=InCompany"
            },
            {
              "name": "variacao_do_funil",
              "value": "=V1"
            },
            {
              "name": "dono",
              "value": "={{ $node[\"consulta_sdr\"].json[\"email\"] }}"
            },
            {
              "name": "qtd_vendedores",
              "value": "={{ $node[\"formata_dados1\"].json[\"qtd_vendedores\"] }}"
            },
            {
              "name": "faturamento",
              "value": "={{ $node[\"formata_dados1\"].json[\"faturamento\"] }}"
            },
            {
              "name": "desafio_comercial",
              "value": "={{ $node[\"formata_dados1\"].json[\"desafio_comercial\"] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "dfc346a7-c84f-4b75-bae1-decf86e66687",
      "name": "create/update clint4",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2200,
        280
      ]
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_url_rotacionamento_colaboradores\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "time",
              "value": "=SDR"
            },
            {
              "name": "id_user",
              "value": "={{ $node[\"cria_atualiza_user\"].json[\"id\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        280
      ],
      "id": "9fb1d498-2765-4225-8e5c-6c210c38622f",
      "name": "consulta_sdr"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Rotacionamento de Colaboradores"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "1ea4634e-be4f-4518-82ca-049b5e449249",
      "name": "pesquisa_url_rotacionamento_colaboradores",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1340,
        280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Users"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "16a53936-7543-4d0f-b42a-be84ad16c689",
      "name": "pesquisa_variavel_n8n_fluxo_users",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1580,
        280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_users\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados1\"].json[\"fname\"] || \"\" }}"
            },
            {
              "name": "sobrenome",
              "value": "={{ $node[\"formata_dados1\"].json[\"lname\"] || \"\" }}"
            },
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados1\"].json[\"email\"] || \"\" }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados1\"].json[\"whatsapp\"] || \"\" }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1800,
        280
      ],
      "id": "88598d42-291c-4a7b-9956-7380c64d5b67",
      "name": "cria_atualiza_user"
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_funis\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id_forms",
              "value": "={{ $node[\"formata_dados1\"].json[\"form_id\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1140,
        280
      ],
      "id": "5d4492c6-0b9e-4b7f-81e3-3cef4d815f8a",
      "name": "busca_funil"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Funis"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "8e29844e-6bc4-4c21-b38d-2a7f51c8c643",
      "name": "pesquisa_variavel_n8n_fluxo_funis",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        940,
        280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "ID Jonatã BC Closer 1",
              "value": "342800505"
            },
            {
              "name": "API-KEY",
              "value": "003f9285-2ed2-4d3c-8f84-18e5a8fab5d3"
            },
            {
              "name": "ID Natalia BC",
              "value": "768179930"
            },
            {
              "name": "ID Felipe  BC",
              "value": "747203618"
            },
            {
              "name": "ID Isabella BC Closer 3",
              "value": "695498921"
            },
            {
              "name": "ID Laiane BC Closer 4",
              "value": "445512667"
            },
            {
              "name": "ID Winicius BC",
              "value": "563485579"
            },
            {
              "name": "ID_grupo_novos_clientes",
              "value": "120363219650907550@g.us"
            },
            {
              "name": "url_base_evolution",
              "value": "https://apievolution.automagicbots.com.br/"
            },
            {
              "name": "instancia_nome",
              "value": "Fabricio-Nunnes"
            },
            {
              "name": "APIKEY_Evolution",
              "value": "D2977F0B8F6C-4B1F-A11C-D78FBA4D10A0"
            },
            {
              "name": "ID Rafael BC",
              "value": "269199328"
            },
            {
              "name": "ID Thiago BC",
              "value": "387179683"
            },
            {}
          ]
        },
        "options": {}
      },
      "id": "e9739dbf-f927-4e72-8e66-0b5bea9a0ecc",
      "name": "infos_bc",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        2400,
        540
      ]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://backend.botconversa.com.br/api/v1/webhook/subscriber/{{ $node[\"infos_bc\"].json[\"ID Jonatã BC Closer 1\"] }}/send_message/",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "value",
              "value": "=🔔 NOTIFICAÇÃO 🔔\n\n🔔 NOVO LEAD NO FUNIL INCOMPANY 🔔\n\n*Nome*: {{ $node[\"formata_dados\"].json[\"fname\"] }} {{ $node[\"formata_dados\"].json[\"lname\"] }}\n*E-mail*: {{ $node[\"formata_dados\"].json[\"email\"] }}\n*Telefone*: {{ $node[\"formata_dados\"].json[\"whatsapp\"] }}\n*WhatsApp*: wa.me/{{ $node[\"formata_dados\"].json[\"whatsapp\"] }}\n*Data de Entrada no Funil*: {{ $now.toFormat('dd/MM/yyyy HH:mm') }}\n*Qtd Vendedores*: {{ $node[\"formata_dados\"].json[\"qtd_vendedores\"] }}\n*Faturamento*: {{ $node[\"formata_dados\"].json[\"faturamento\"] }}\n*Desafio Comercial*: {{ $node[\"formata_dados\"].json[\"desafio_comercial\"] }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "API-KEY",
              "value": "={{ $node[\"infos_bc\"].json[\"API-KEY\"] }}"
            }
          ]
        }
      },
      "name": "avisa_Closer1_Jonatã",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2780,
        300
      ],
      "id": "a4c081ff-e803-49c4-ba10-618386e21f9f",
      "continueOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://backend.botconversa.com.br/api/v1/webhook/subscriber/{{ $node[\"infos_bc\"].json[\"ID Natalia BC\"] }}/send_message/",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "value",
              "value": "=🔔 NOTIFICAÇÃO 🔔\n\n🔔 NOVO LEAD NO FUNIL INDICAÇÃO 🔔\n\n*Nome de quem está indicando*: {{ $node[\"formata_dados\"].json[\"fullName\"] }}\n*Empresa de quem está indicando*: {{ $node[\"formata_dados\"].json[\"nome_empresa\"] }}\n*Empresa indicada - Nome*: {{ $node[\"formata_dados\"].json[\"empresa_indicada\"] }}\n*Empresa Indicada - Dono*: {{ $node[\"formata_dados\"].json[\"dono_empresa\"] }}\n*Empresa Indicada - Telefone*: {{ $node[\"formata_dados\"].json[\"telefone_dono\"] }}\n*Empresa Indicada - Instagram*: {{ $node[\"formata_dados\"].json[\"instagram\"] }}\n*Comunicou o Dono sobre a indicação?*: {{ $node[\"formata_dados\"].json[\"comunicou_dono\"] }}\n*Data de Entrada no Funil*: {{ $now.toFormat('dd/MM/yyyy HH:mm') }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "API-KEY",
              "value": "={{ $node[\"infos_bc\"].json[\"API-KEY\"] }}"
            }
          ]
        }
      },
      "name": "avisa_Natalia",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2620,
        540
      ],
      "id": "70bf0257-6d52-465c-90cf-d3e0697fe60c",
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// 📌 Capturar os dados de entrada (suporta payload como array ou objeto)\nconst root = Array.isArray(items[0].json) ? items[0].json[0] : items[0].json;\nconst formResponse = root?.body?.form_response || {};\nconst respostas = formResponse.answers || [];\nconst hidden = formResponse.hidden || {};\n\n// 📌 Mapear SOMENTE os campos solicitados\nconst perguntasMap = {\n  \"7ac65be4-a3c5-435f-9adb-53ae40aa5f73\": \"fullName\",\n  \"fe2465c0-313f-483a-b6e6-cf4213684b88\": \"nome_empresa\",\n  \"be2fdf3d-17e3-41d6-98b3-07208c03bcdb\": \"dono_empresa\",\n  \"1ebafb0d-ba6a-4e29-8384-12c2e3ce314d\": \"telefone_dono\",\n  \"7fcf296c-97d1-4fd3-b16e-aaa503d68347\": \"empresa_indicada\",\n  \"4dba5c12-bf29-4be3-b7c2-cf2411e541a0\": \"instagram\",\n  \"1774737a-35cd-4441-9aae-61d2b0c03e10\": \"comunicou_dono\"\n};\n\n// 🔤 Normalizador \"sim\"/\"não\"\nfunction normalizeSimNao(v) {\n  if (v === undefined || v === null) return \"\";\n  const s = String(v).trim().toLowerCase();\n  if ([\"sim\",\"yes\",\"y\",\"true\",\"1\",\"on\"].includes(s)) return \"sim\";\n  if ([\"não\",\"nao\",\"no\",\"n\",\"false\",\"0\",\"off\"].includes(s)) return \"não\";\n  if (s.includes(\"sim\")) return \"sim\";\n  if (s.includes(\"não\") || s.includes(\"nao\")) return \"não\";\n  return \"\";\n}\n\n// 🧠 Extrair especificamente o comunicou_dono\nfunction extractComunicou(answer) {\n  if (!answer) return \"\";\n  if (answer.type === \"boolean\") return normalizeSimNao(answer.boolean);\n  if (answer.type === \"choice\")  return normalizeSimNao(answer.choice?.label);\n  if (answer.type === \"choices\") {\n    const labels = answer.choices?.labels || [];\n    if (labels.some(l => normalizeSimNao(l) === \"sim\")) return \"sim\";\n    if (labels.some(l => normalizeSimNao(l) === \"não\")) return \"não\";\n    return normalizeSimNao(labels.join(\", \"));\n  }\n  const raw = answer[answer.type] ?? answer.choice?.label ?? (answer.choices?.labels || []).join(\", \") ?? \"\";\n  return normalizeSimNao(raw);\n}\n\nfunction formatPhone(phone) {\n  if (!phone) return \"\";\n  const digitsOnly = String(phone).replace(/\\D/g, \"\");\n  const withDDI = digitsOnly.startsWith(\"55\") ? digitsOnly : `55${digitsOnly}`;\n  const DDD = withDDI.slice(2, 4);\n  let numero = withDDI.slice(4);\n  if (numero.length === 8) numero = `9${numero}`;\n  return `55${DDD}${numero}`;\n}\n\nfunction formatInstagram(instagram) {\n  return instagram ? String(instagram).toLowerCase().replace(/^@/, \"\") : \"\";\n}\n\n// 📆 Converter submitted_at → YYYY-MM-DD HH:mm:ss GMT-3\nfunction formatDateTimeGMT3(iso) {\n  if (!iso) return \"\";\n  const d = new Date(iso);\n  d.setHours(d.getHours() - 0); // Ajuste -3h (SP sem DST)\n  const yyyy = d.getFullYear();\n  const mm = String(d.getMonth() + 1).padStart(2, \"0\");\n  const dd = String(d.getDate()).padStart(2, \"0\");\n  const HH = String(d.getHours()).padStart(2, \"0\");\n  const II = String(d.getMinutes()).padStart(2, \"0\");\n  const SS = String(d.getSeconds()).padStart(2, \"0\");\n  return `${yyyy}-${mm}-${dd} ${HH}:${II}:${SS}`;\n}\n\n// 📦 Montagem apenas dos campos solicitados\nconst respostasMapeadas = {};\nrespostas.forEach(answer => {\n  const ref = answer.field?.ref;\n  const key = perguntasMap[ref];\n  if (!key) return;\n\n  if (key === \"comunicou_dono\") {\n    respostasMapeadas.comunicou_dono = extractComunicou(answer);\n    return;\n  }\n\n  if (answer.type === \"choice\") {\n    respostasMapeadas[key] = answer.choice?.label || \"\";\n  } else if (answer.type === \"choices\") {\n    respostasMapeadas[key] = (answer.choices?.labels || []).join(\", \");\n  } else if ([\"text\",\"email\",\"phone_number\",\"url\"].includes(answer.type)) {\n    respostasMapeadas[key] = answer[answer.type] || \"\";\n  } else if (answer.type === \"number\") {\n    respostasMapeadas[key] = answer.number ?? \"\";\n  } else if (answer.type === \"boolean\") {\n    respostasMapeadas[key] = String(!!answer.boolean);\n  } else {\n    respostasMapeadas[key] = \"\";\n  }\n});\n\n// ➕ Fallbacks do hidden\nif (!respostasMapeadas.fullName)      respostasMapeadas.fullName      = hidden.name  || \"\";\nif (!respostasMapeadas.telefone_dono) respostasMapeadas.telefone_dono = hidden.phone || \"\";\nif (!respostasMapeadas.comunicou_dono && hidden.comunicou_dono) {\n  respostasMapeadas.comunicou_dono = normalizeSimNao(hidden.comunicou_dono);\n}\n\n// Normalizações finais\nif (respostasMapeadas.telefone_dono) {\n  respostasMapeadas.telefone_dono = formatPhone(respostasMapeadas.telefone_dono);\n}\nif (respostasMapeadas.instagram) {\n  respostasMapeadas.instagram = formatInstagram(respostasMapeadas.instagram);\n}\n\n// 📌 Capturar UTMs e outros campos\nconst utm_source   = hidden.utm_source   ?? root.utm_source   ?? \"\";\nconst utm_campaign = hidden.utm_campaign ?? root.utm_campaign ?? \"\";\nconst utm_medium   = hidden.utm_medium   ?? root.utm_medium   ?? \"\";\nconst utm_term     = hidden.utm_term     ?? root.utm_term     ?? \"\";\nconst utm_content  = hidden.utm_content  ?? root.utm_content  ?? \"\";\n\nconst form_id   = formResponse.form_id || \"\";\nconst form_name = formResponse.definition?.title || \"\";\nconst data_envio = formatDateTimeGMT3(formResponse.submitted_at);\nconst url_pagina = hidden.origin ?? hidden.url ?? root.origin ?? \"\";\n\n// ✅ Resultado final\nconst result = {\n  fullName:         respostasMapeadas.fullName        || \"\",\n  nome_empresa:     respostasMapeadas.nome_empresa    || \"\",\n  dono_empresa:     respostasMapeadas.dono_empresa    || \"\",\n  telefone_dono:    respostasMapeadas.telefone_dono   || \"\",\n  empresa_indicada: respostasMapeadas.empresa_indicada|| \"\",\n  instagram:        respostasMapeadas.instagram       || \"\",\n  comunicou_dono:   respostasMapeadas.comunicou_dono  || \"\",\n\n  utm_source,\n  utm_campaign,\n  utm_term,\n  utm_medium,\n  utm_content,\n  form_id,\n  form_name,\n  data_envio,   // agora no formato YYYY-MM-DD HH:mm:ss GMT-3\n  url_pagina\n};\n\nreturn [{ json: result }];\n"
      },
      "id": "de5d3924-e1a4-427e-b837-8911953cef2f",
      "name": "formata_dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        740,
        540
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://functions-api.clint.digital/endpoints/integration/webhook/76eeabf3-714a-4923-9cfb-80eab90af0dc",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados\"].json[\"dono_empresa\"] }}"
            },
            {
              "name": "telefone_dono",
              "value": "={{ $node[\"formata_dados\"].json[\"telefone_dono\"] }}"
            },
            {
              "name": "instagram",
              "value": "={{ $node[\"formata_dados\"].json[\"instagram\"] }}"
            },
            {
              "name": "utm_source",
              "value": "={{ $node[\"formata_dados\"].json[\"utm_source\"] }}"
            },
            {
              "name": "utm_campaign",
              "value": "={{ $node[\"formata_dados\"].json[\"utm_campaign\"] }}"
            },
            {
              "name": "utm_term",
              "value": "={{ $node[\"formata_dados\"].json[\"utm_term\"] }}"
            },
            {
              "name": "utm_medium",
              "value": "={{ $node[\"formata_dados\"].json[\"utm_medium\"] }}"
            },
            {
              "name": "utm_content",
              "value": "={{ $node[\"formata_dados\"].json[\"utm_content\"] }}"
            },
            {
              "name": "funil",
              "value": "=Formulário de Indicação"
            },
            {
              "name": "variacao_do_funil",
              "value": "=V1"
            },
            {
              "name": "quem_indica",
              "value": "={{ $node[\"formata_dados\"].json[\"fullName\"] }}"
            },
            {
              "name": "empresa_que_indica",
              "value": "={{ $node[\"formata_dados\"].json[\"nome_empresa\"] }}"
            },
            {
              "name": "empresa_indicada",
              "value": "={{ $node[\"formata_dados\"].json[\"empresa_indicada\"] }}"
            },
            {
              "name": "comunicou_dono",
              "value": "={{ $node[\"formata_dados\"].json[\"comunicou_dono\"] }}"
            },
            {
              "name": "data_envio",
              "value": "={{ $node[\"formata_dados\"].json[\"data_envio\"] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "224347fe-1200-4b09-9391-cb7c7e26d7df",
      "name": "create/update clint",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2200,
        540
      ]
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_url_rotacionamento_colaboradores1\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "time",
              "value": "=SDR"
            },
            {
              "name": "id_user",
              "value": "={{ $node[\"cria_atualiza_user1\"].json[\"id\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        540
      ],
      "id": "5187ba85-d59a-45e7-88ef-5e227b906868",
      "name": "consulta_sdr1"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Rotacionamento de Colaboradores"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "701ec31c-3d84-4f85-9144-12f5f4c6b2ec",
      "name": "pesquisa_url_rotacionamento_colaboradores1",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1340,
        540
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Users"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "36c0c252-1aae-4441-8af2-e60012353b84",
      "name": "pesquisa_variavel_n8n_fluxo_users1",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1580,
        540
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_users1\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados\"].json[\"dono_empresa\"] }}"
            },
            {
              "name": "sobrenome",
              "value": "={{ $node[\"formata_dados\"].json[\"lname\"] || \"\" }}"
            },
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados\"].json[\"email\"] || \"\" }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados\"].json[\"telefone_dono\"] }}"
            },
            {
              "name": "instagram",
              "value": "={{ $node[\"formata_dados\"].json[\"instagram\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1800,
        540
      ],
      "id": "18a05917-d3b0-46a0-975c-3fce2d9a6931",
      "name": "cria_atualiza_user1"
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_funis1\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id_forms",
              "value": "={{ $node[\"formata_dados\"].json[\"form_id\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1140,
        540
      ],
      "id": "5daeacac-28fc-48b1-bab1-648a8134cb20",
      "name": "busca_funil1"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Funis"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "2b043d70-b884-41ef-86be-f3141799d201",
      "name": "pesquisa_variavel_n8n_fluxo_funis1",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        940,
        540
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "popup-incompany",
        "options": {}
      },
      "id": "ec5d6445-8a22-4548-a0d6-6e54421a537d",
      "name": "Popup-InCompany",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        540,
        280
      ],
      "webhookId": "e81bd704-ef97-4025-bd96-ff159a6ef22b",
      "disabled": true
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "typeform-indicacao",
        "options": {}
      },
      "id": "10e940c1-7128-437b-bd78-e21dd483cfa8",
      "name": "typeform-InCompany1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        540,
        540
      ],
      "webhookId": "25a38346-fd9e-4066-9f81-f7c28e79e346"
    }
  ],
  "pinData": {
    "Popup-InCompany": [
      {
        "json": {
          "headers": {
            "host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "user-agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/140.0.0.0 Safari/537.36",
            "content-length": "261",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br, zstd",
            "accept-language": "pt-PT,pt;q=0.9,en-US;q=0.8,en;q=0.7",
            "content-type": "application/json",
            "origin": "https://incompany.universidadevendas.com.br",
            "priority": "u=1, i",
            "referer": "https://incompany.universidadevendas.com.br/",
            "sec-ch-ua": "\"Chromium\";v=\"140\", \"Not=A?Brand\";v=\"24\", \"Google Chrome\";v=\"140\"",
            "sec-ch-ua-mobile": "?0",
            "sec-ch-ua-platform": "\"Windows\"",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "x-forwarded-for": "201.17.208.252",
            "x-forwarded-host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "77400aba3c69",
            "x-real-ip": "201.17.208.252"
          },
          "params": {},
          "query": {},
          "body": {
            "name": "Mateus Automagic",
            "phone": "(31) 99279-6934",
            "email": "contato.mportob@gmail.com",
            "timestamp": "2025-09-16T14:27:29.567Z",
            "source": "landing_page_popup",
            "popup_id": "prequalification-popup",
            "utm_source": "",
            "utm_medium": "",
            "utm_campaign": "",
            "utm_content": ""
          },
          "webhookUrl": "https://webhookeditorhetznerfabricionunnes.automagicbots.com.br/webhook/popup-incompany",
          "executionMode": "production"
        }
      }
    ],
    "typeform-InCompany1": [
      {
        "json": {
          "headers": {
            "host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "user-agent": "Typeform Webhooks",
            "content-length": "2825",
            "accept-encoding": "gzip",
            "content-type": "application/json",
            "traceparent": "00-5756db84d7c5794920bef49e4bf649f1-879a192756315ee5-01",
            "x-forwarded-for": "34.230.177.131",
            "x-forwarded-host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "77400aba3c69",
            "x-real-ip": "34.230.177.131"
          },
          "params": {},
          "query": {},
          "body": {
            "event_id": "01K74Q19C28NRA1KN7JHB87FD5",
            "event_type": "form_response",
            "form_response": {
              "form_id": "roxhiaPX",
              "token": "cdqrwv5j4w2f3dalelx7c8cdqrwv7qt6",
              "landed_at": "2025-10-09T14:44:34Z",
              "submitted_at": "2025-10-09T14:47:06Z",
              "hidden": {
                "utm_campaign": "quente",
                "utm_content": "forms-indicacao",
                "utm_medium": "botao-typeform",
                "utm_source": "typeform",
                "utm_term": "indicacao"
              },
              "definition": {
                "id": "roxhiaPX",
                "title": "Indicações",
                "fields": [
                  {
                    "id": "GkhJAp4xiqq7",
                    "ref": "7ac65be4-a3c5-435f-9adb-53ae40aa5f73",
                    "type": "short_text",
                    "title": "Qual seu nome completo?",
                    "properties": {}
                  },
                  {
                    "id": "Gj7z1vsmtNjs",
                    "ref": "fe2465c0-313f-483a-b6e6-cf4213684b88",
                    "type": "short_text",
                    "title": "Qual o nome da sua empresa?",
                    "properties": {}
                  },
                  {
                    "id": "AnAGPZoosFn2",
                    "ref": "be2fdf3d-17e3-41d6-98b3-07208c03bcdb",
                    "type": "short_text",
                    "title": "Qual nome do dono da empresa indicada?",
                    "properties": {}
                  },
                  {
                    "id": "jo1DzlGqV1lr",
                    "ref": "1ebafb0d-ba6a-4e29-8384-12c2e3ce314d",
                    "type": "phone_number",
                    "title": "Qual o telefone do dono da empresa indicada?",
                    "properties": {}
                  },
                  {
                    "id": "fyUCIPDSqGMO",
                    "ref": "7fcf296c-97d1-4fd3-b16e-aaa503d68347",
                    "type": "short_text",
                    "title": "Qual o nome da empresa indicada?",
                    "properties": {}
                  },
                  {
                    "id": "miBfBpygymqe",
                    "ref": "4dba5c12-bf29-4be3-b7c2-cf2411e541a0",
                    "type": "short_text",
                    "title": "Qual o instagram da empresa indicada?",
                    "properties": {}
                  },
                  {
                    "id": "lUAEsNYYHd0e",
                    "ref": "1774737a-35cd-4441-9aae-61d2b0c03e10",
                    "type": "yes_no",
                    "title": "Você já comunicou ao dono da empresa sobre a indicação?",
                    "properties": {}
                  }
                ],
                "endings": [
                  {
                    "id": "zaPi4zsS48qU",
                    "ref": "3e33071d-3951-4f78-8408-a7ab5297a1e6",
                    "title": "Obrigado pela indicação! Assim que avançarmos te mantemos informado",
                    "type": "thankyou_screen",
                    "properties": {
                      "button_text": "Cria um typeform",
                      "show_button": true,
                      "share_icons": true,
                      "button_mode": "default_redirect"
                    }
                  }
                ],
                "settings": {
                  "partial_responses_to_all_integrations": true
                }
              },
              "answers": [
                {
                  "type": "text",
                  "text": "Porto Teste",
                  "field": {
                    "id": "GkhJAp4xiqq7",
                    "type": "short_text",
                    "ref": "7ac65be4-a3c5-435f-9adb-53ae40aa5f73"
                  }
                },
                {
                  "type": "text",
                  "text": "Teste Automagic",
                  "field": {
                    "id": "Gj7z1vsmtNjs",
                    "type": "short_text",
                    "ref": "fe2465c0-313f-483a-b6e6-cf4213684b88"
                  }
                },
                {
                  "type": "text",
                  "text": "Jose teste",
                  "field": {
                    "id": "AnAGPZoosFn2",
                    "type": "short_text",
                    "ref": "be2fdf3d-17e3-41d6-98b3-07208c03bcdb"
                  }
                },
                {
                  "type": "phone_number",
                  "phone_number": "+5599988776655",
                  "field": {
                    "id": "jo1DzlGqV1lr",
                    "type": "phone_number",
                    "ref": "1ebafb0d-ba6a-4e29-8384-12c2e3ce314d"
                  }
                },
                {
                  "type": "text",
                  "text": "Bots Test",
                  "field": {
                    "id": "fyUCIPDSqGMO",
                    "type": "short_text",
                    "ref": "7fcf296c-97d1-4fd3-b16e-aaa503d68347"
                  }
                },
                {
                  "type": "text",
                  "text": "botstest",
                  "field": {
                    "id": "miBfBpygymqe",
                    "type": "short_text",
                    "ref": "4dba5c12-bf29-4be3-b7c2-cf2411e541a0"
                  }
                },
                {
                  "type": "boolean",
                  "boolean": true,
                  "field": {
                    "id": "lUAEsNYYHd0e",
                    "type": "yes_no",
                    "ref": "1774737a-35cd-4441-9aae-61d2b0c03e10"
                  }
                }
              ],
              "ending": {
                "id": "zaPi4zsS48qU",
                "ref": "3e33071d-3951-4f78-8408-a7ab5297a1e6"
              }
            }
          },
          "webhookUrl": "https://webhookeditorhetznerfabricionunnes.automagicbots.com.br/webhook/typeform-indicacao",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "Q8rgTKWALfDjS7MZ"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-10-09T15:10:42.134Z",
  "versionId": "d1f5100a-28be-430d-be2d-af59f0b5e6d2"
}