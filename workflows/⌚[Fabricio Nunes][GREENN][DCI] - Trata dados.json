{
  "active": true,
  "connections": {
    "pesquisa_url_rotacionamento_colaboradores": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_users",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_users": {
      "main": [
        [
          {
            "node": "cria_atualiza_user",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria_atualiza_user": {
      "main": [
        [
          {
            "node": "executa_procedure1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_funil": {
      "main": [
        [
          {
            "node": "pesquisa_url_rotacionamento_colaboradores",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_funis": {
      "main": [
        [
          {
            "node": "busca_funil",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "infos_bc": {
      "main": [
        [
          {
            "node": "avisa_Closer1_Jonatã",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "avisa_Closer1_Jonatã": {
      "main": [
        [
          {
            "node": "avisa_Natalia",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formata_dados1": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_funis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados_da_compra2": {
      "main": [
        [
          {
            "node": "formata_dados1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "executa_procedure1": {
      "main": [
        [
          {
            "node": "Limit1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit1": {
      "main": [
        [
          {
            "node": "cria_ou_atualiza_contato_na_clint1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "formata_dados2": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_funis2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_url_rotacionamento_colaboradores2": {
      "main": [
        [
          {
            "node": "pesquisa_variavel_n8n_fluxo_users2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_users2": {
      "main": [
        [
          {
            "node": "cria_atualiza_user2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "cria_atualiza_user2": {
      "main": [
        [
          {
            "node": "executa_procedure2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "busca_funil2": {
      "main": [
        [
          {
            "node": "pesquisa_url_rotacionamento_colaboradores2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "pesquisa_variavel_n8n_fluxo_funis2": {
      "main": [
        [
          {
            "node": "busca_funil2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "dados_da_compra3": {
      "main": [
        [
          {
            "node": "formata_dados2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "executa_procedure2": {
      "main": [
        [
          {
            "node": "Limit2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit2": {
      "main": [
        [
          {
            "node": "cria_ou_atualiza_contato_na_clint",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "aguardando_pagamento": {
      "main": [
        [
          {
            "node": "dados_da_compra2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "compra_aprovada": {
      "main": [
        [
          {
            "node": "dados_da_compra3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "createdAt": "2025-09-26T21:22:20.599Z",
  "id": "qCcjFG0ymcUx44w7",
  "meta": {
    "templateCredsSetupCompleted": true
  },
  "name": "⌚[Fabricio Nunes][GREENN][DCI] - Trata dados",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ===== FORMATA DADOS — igual ao anterior, mas \"data_garantia\" agora é DATE (yyyy-MM-dd) =====\n\nconst root = items[0]?.json ?? {};\nconst payload = Array.isArray(root) ? (root[0] ?? {}) : (root.body ?? root);\n\nfunction capitalizeName(fullName) {\n  if (!fullName) return { fname: '', lname: '', fullname: '' };\n  const lowers = ['da','de','do','di','du'];\n  const parts = String(fullName).toLowerCase().split(/\\s+/).filter(Boolean)\n    .map((w,i) => (lowers.includes(w) && i !== 0) ? w : w.charAt(0).toUpperCase() + w.slice(1));\n  const fname = parts.shift() || '';\n  const lname = parts.join(' ');\n  return { fname, lname, fullname: `${fname}${lname ? ' ' + lname : ''}`.trim() };\n}\nfunction toZapiPhone(v){\n  if (!v) return '';\n  const raw = String(v).replace(/\\D/g,'');\n  const noDDI = raw.startsWith('55') ? raw.slice(2) : raw;\n  const ddd = noDDI.slice(0,2);\n  let num = noDDI.slice(2);\n  if (num.length >= 9) num = num.slice(-9);\n  else if (num.length === 8) num = num.slice(-8);\n  return `55${ddd}${num}`;\n}\nfunction fmtEmail(e){ return e ? String(e).toLowerCase().trim() : ''; }\n\n// ➜ Formata data/hora BR para TIMESTAMP ISO (com -3h)\nfunction fmtDateBRToISO(dt) {\n  if (!dt) return '';\n  const s = String(dt).trim();\n  let m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})\\s+(\\d{2}):(\\d{2})(?::(\\d{2}))?$/);\n  if (m) {\n    const [, d, mo, y, h, mi, ss] = m;\n    const date = new Date(`${y}-${mo}-${d}T${h}:${mi}:${ss ?? '00'}Z`);\n    // aplica -3h\n    date.setHours(date.getHours() - 0);\n    const yyyy = date.getFullYear();\n    const mm = String(date.getMonth() + 1).padStart(2, \"0\");\n    const dd = String(date.getDate()).padStart(2, \"0\");\n    const HH = String(date.getHours()).padStart(2, \"0\");\n    const II = String(date.getMinutes()).padStart(2, \"0\");\n    const SS = String(date.getSeconds()).padStart(2, \"0\");\n    return `${yyyy}-${mm}-${dd} ${HH}:${II}:${SS}`;\n  }\n  m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (m) {\n    const [, d, mo, y] = m;\n    return `${y}-${mo}-${d} 00:00:00`;\n  }\n  return '';\n}\n\n// ➜ Apenas DATE (yyyy-MM-dd)\nfunction fmtDateBRToISODate(dt) {\n  if (!dt) return '';\n  const s = String(dt).trim();\n  const m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})(?:\\s+\\d{2}:\\d{2}(?::\\d{2})?)?$/);\n  if (!m) return '';\n  const [, d, mo, y] = m;\n  return `${y}-${mo}-${d}`;\n}\nfunction mapStatus(s){ return s === 'waiting_payment' ? 'Aguardando Pagamento' : (s || ''); }\nfunction numOrNull(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }\nfunction strOrEmpty(v){ return v == null ? '' : String(v); }\n\nconst nomeCliente   = payload['Nome do Cliente'] ?? '';\nconst emailCliente  = payload['E-mail do Cliente'] ?? '';\nconst telCliente    = payload['Telefone do Cliente'] ?? '';\nconst cpfcnpj       = payload['cpf/cnpj'] ?? '';\nconst nomeProduto   = payload['nome_produto'] ?? '';\n\nconst idTransacao   = payload['id_transacao_checkout'];\nconst idProduto     = payload['id_produto'];\nconst valor         = payload['valor'];\nconst oferta        = payload['oferta'] ?? '';\nconst formaPgto     = payload['forma_de_pagamento'] ?? '';\nconst statusCompra  = payload['status_da_compra'] ?? '';\nconst dataConvBR    = payload['data_conversao'] ?? '';\nconst period        = payload['period'];\nconst parcelas      = payload['parcelas'];\nconst ddd           = payload['ddd'] ?? '';\nconst cep           = payload['cep'];\n\nconst utm_source    = payload['utm_source'] ?? '';\nconst utm_campaign  = payload['utm_campaign'] ?? '';\nconst utm_medium    = payload['utm_medium'] ?? '';\nconst utm_content   = payload['utm_content'] ?? '';\nconst utm_term      = payload['utm_term'] ?? '';\n\nconst comissaoGw    = payload['comissao_gateway'];\nconst clientId      = payload['client_id'];\nconst sellerBalance = payload['seller_balance'];\nconst dataGarantiaBR= payload['data_garantia'] ?? '';\nconst codePix       = payload['code_pix'] ?? '';\nconst qrcodePix     = payload['qrcode_pix'] ?? '';\nconst moeda         = payload['moeda'] ?? '';\nconst linkPagamentoBoleto = payload['link_pagamento_boleto'] ?? '';\n\nconst { fname, lname, fullname } = capitalizeName(nomeCliente);\nconst emailFmt      = fmtEmail(emailCliente);\nconst whatsappZapi  = toZapiPhone(telCliente);\nconst dataConversao = fmtDateBRToISO(dataConvBR); // agora com -3h\nconst dataGarantia  = fmtDateBRToISODate(dataGarantiaBR); \nconst statusFmt     = mapStatus(statusCompra);\n\nconst out = {\n  fname, lname, fullname,\n  email: emailFmt,\n  whatsapp: whatsappZapi,\n\n  \"Nome do Cliente\": fullname || strOrEmpty(nomeCliente),\n  \"E-mail do Cliente\": emailFmt,\n  \"Telefone do Cliente\": strOrEmpty(telCliente),\n  \"cpf/cnpj\": strOrEmpty(cpfcnpj),\n  \"nome_produto\": strOrEmpty(nomeProduto),\n\n  \"id_transacao_checkout\": numOrNull(idTransacao),\n  \"id_produto\": numOrNull(idProduto),\n  \"valor\": numOrNull(valor),\n  \"oferta\": strOrEmpty(oferta),\n  \"forma_de_pagamento\": strOrEmpty(formaPgto),\n  \"status_da_compra\": statusFmt,\n  \"data_conversao\": dataConversao, // ✅ ajustado com -3h\n  \"period\": numOrNull(period),\n  \"parcelas\": numOrNull(parcelas),\n  \"ddd\": strOrEmpty(ddd),\n  \"cep\": (cep === null ? null : strOrEmpty(cep)),\n\n  \"utm_source\": strOrEmpty(utm_source),\n  \"utm_campaign\": strOrEmpty(utm_campaign),\n  \"utm_medium\": strOrEmpty(utm_medium),\n  \"utm_content\": strOrEmpty(utm_content),\n  \"utm_term\": strOrEmpty(utm_term),\n\n  \"comissao_gateway\": numOrNull(comissaoGw),\n  \"client_id\": numOrNull(clientId),\n  \"seller_balance\": numOrNull(sellerBalance),\n  \"data_garantia\": dataGarantia, \n  \"code_pix\": strOrEmpty(codePix),\n  \"qrcode_pix\": strOrEmpty(qrcodePix),\n  \"moeda\": strOrEmpty(moeda),\n  \"link_pagamento_boleto\": strOrEmpty(linkPagamentoBoleto)\n};\n\nreturn [{ json: out }];\n"
      },
      "id": "1a91bc72-65d4-47b9-adf2-62537e1cf85e",
      "name": "formata_dados1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        980,
        280
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Rotacionamento de Colaboradores"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "5149c259-e94c-42ee-98ff-35af440be691",
      "name": "pesquisa_url_rotacionamento_colaboradores",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1580,
        280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Users"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "2d4f0183-e785-4604-b597-a0d13227c5aa",
      "name": "pesquisa_variavel_n8n_fluxo_users",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1800,
        280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_users\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados1\"].json[\"fname\"] || \"\" }}"
            },
            {
              "name": "sobrenome",
              "value": "={{ $node[\"formata_dados1\"].json[\"lname\"] || \"\" }}"
            },
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados1\"].json[\"email\"] || \"\" }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados1\"].json[\"whatsapp\"] || \"\" }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        280
      ],
      "id": "e4151a81-2d1c-42fc-88f6-be2db3b87786",
      "name": "cria_atualiza_user"
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_funis\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id_forms",
              "value": "={{ $node[\"dados_da_compra2\"].json[\"form_id\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1380,
        280
      ],
      "id": "92559cda-b7a5-4963-92e5-9a674af922a0",
      "name": "busca_funil"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Funis"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "5e2b9605-9d6d-466a-96b1-cd6b33480a75",
      "name": "pesquisa_variavel_n8n_fluxo_funis",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1200,
        280
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "ID Jonatã BC Closer 1",
              "value": "342800505"
            },
            {
              "name": "API-KEY",
              "value": "003f9285-2ed2-4d3c-8f84-18e5a8fab5d3"
            },
            {
              "name": "ID Natalia BC",
              "value": "768179930"
            },
            {
              "name": "ID Felipe  BC",
              "value": "747203618"
            },
            {
              "name": "ID Isabella BC Closer 3",
              "value": "695498921"
            },
            {
              "name": "ID Laiane BC Closer 4",
              "value": "445512667"
            },
            {
              "name": "ID Winicius BC",
              "value": "563485579"
            },
            {
              "name": "ID_grupo_novos_clientes",
              "value": "120363219650907550@g.us"
            },
            {
              "name": "url_base_evolution",
              "value": "https://apievolution.automagicbots.com.br/"
            },
            {
              "name": "instancia_nome",
              "value": "Fabricio-Nunnes"
            },
            {
              "name": "APIKEY_Evolution",
              "value": "D2977F0B8F6C-4B1F-A11C-D78FBA4D10A0"
            },
            {
              "name": "ID Rafael BC",
              "value": "269199328"
            },
            {
              "name": "ID Thiago BC",
              "value": "387179683"
            },
            {}
          ]
        },
        "options": {}
      },
      "id": "b48d3e7f-262e-4ec1-9bea-ffd360f1318f",
      "name": "infos_bc",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        2020,
        580
      ]
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://backend.botconversa.com.br/api/v1/webhook/subscriber/{{ $node[\"infos_bc\"].json[\"ID Jonatã BC Closer 1\"] }}/send_message/",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "value",
              "value": "=🔔 NOTIFICAÇÃO 🔔\n\n🔔 NOVO LEAD NO FUNIL INCOMPANY 🔔\n\n*Nome*: {{ $node[\"formata_dados\"].json[\"fname\"] }} {{ $node[\"formata_dados\"].json[\"lname\"] }}\n*E-mail*: {{ $node[\"formata_dados\"].json[\"email\"] }}\n*Telefone*: {{ $node[\"formata_dados\"].json[\"whatsapp\"] }}\n*WhatsApp*: wa.me/{{ $node[\"formata_dados\"].json[\"whatsapp\"] }}\n*Data de Entrada no Funil*: {{ $now.toFormat('dd/MM/yyyy HH:mm') }}\n*Qtd Vendedores*: {{ $node[\"formata_dados\"].json[\"qtd_vendedores\"] }}\n*Faturamento*: {{ $node[\"formata_dados\"].json[\"faturamento\"] }}\n*Desafio Comercial*: {{ $node[\"formata_dados\"].json[\"desafio_comercial\"] }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "API-KEY",
              "value": "={{ $node[\"infos_bc\"].json[\"API-KEY\"] }}"
            }
          ]
        }
      },
      "name": "avisa_Closer1_Jonatã",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2180,
        580
      ],
      "id": "4b8d6271-d5ff-4569-bf2c-5efdcde4bc52",
      "continueOnFail": true
    },
    {
      "parameters": {
        "requestMethod": "POST",
        "url": "=https://backend.botconversa.com.br/api/v1/webhook/subscriber/{{ $node[\"infos_bc\"].json[\"ID Natalia BC\"] }}/send_message/",
        "options": {},
        "bodyParametersUi": {
          "parameter": [
            {
              "name": "type",
              "value": "text"
            },
            {
              "name": "value",
              "value": "=🔔 NOTIFICAÇÃO 🔔\n\n🔔 NOVO LEAD NO FUNIL INCOMPANY 🔔\n\n*Nome*: {{ $node[\"formata_dados\"].json[\"fname\"] }} {{ $node[\"formata_dados\"].json[\"lname\"] }}\n*E-mail*: {{ $node[\"formata_dados\"].json[\"email\"] }}\n*Telefone*: {{ $node[\"formata_dados\"].json[\"whatsapp\"] }}\n*WhatsApp*: wa.me/{{ $node[\"formata_dados\"].json[\"whatsapp\"] }}\n*Data de Entrada no Funil*: {{ $now.toFormat('dd/MM/yyyy HH:mm') }}\n*Qtd Vendedores*: {{ $node[\"formata_dados\"].json[\"qtd_vendedores\"] }}\n*Faturamento*: {{ $node[\"formata_dados\"].json[\"faturamento\"] }}\n*Desafio Comercial*: {{ $node[\"formata_dados\"].json[\"desafio_comercial\"] }}"
            }
          ]
        },
        "headerParametersUi": {
          "parameter": [
            {
              "name": "API-KEY",
              "value": "={{ $node[\"infos_bc\"].json[\"API-KEY\"] }}"
            }
          ]
        }
      },
      "name": "avisa_Natalia",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 2,
      "position": [
        2380,
        580
      ],
      "id": "0c00fdd2-1101-4b46-8346-c11c3a47f574",
      "continueOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://functions-api.clint.digital/endpoints/integration/webhook/d71a392a-c360-4cf4-a45e-d99e8067dcf6",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados1\"].json[\"E-mail do Cliente\"] }}"
            },
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados1\"].json[\"Nome do Cliente\"] }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados1\"].json[\"whatsapp\"] }}"
            },
            {
              "name": "cpf/cnpj",
              "value": "={{ $node[\"formata_dados1\"].json[\"cpf/cnpj\"] }}"
            },
            {
              "name": "produto",
              "value": "={{ $node[\"formata_dados1\"].json[\"nome_produto\"] }}"
            },
            {
              "name": "metodo_pagamento",
              "value": "={{ $node[\"formata_dados1\"].json[\"forma_de_pagamento\"] }}"
            },
            {
              "name": "parcelas",
              "value": "={{ $node[\"formata_dados1\"].json[\"parcelas\"] }}"
            },
            {
              "name": "valor",
              "value": "={{ $node[\"formata_dados1\"].json[\"valor\"] }}"
            },
            {
              "name": "Plataforma",
              "value": "Green"
            },
            {
              "name": "status_da_compra",
              "value": "={{ $node[\"formata_dados1\"].json[\"status_da_compra\"] }}"
            },
            {
              "name": "Link do boleto",
              "value": "={{ $node[\"formata_dados1\"].json[\"link_pagamento_boleto\"] }}"
            },
            {
              "name": "Código Pix",
              "value": "={{ $node[\"formata_dados1\"].json[\"code_pix\"] }}"
            },
            {
              "name": "Data da Compra",
              "value": "={{ $node[\"formata_dados1\"].json[\"data_conversao\"] }}"
            },
            {
              "name": "Data da Garantia",
              "value": "={{ $node[\"formata_dados1\"].json[\"data_garantia\"] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "0140f7c9-2a5b-4723-8672-6ee44808a355",
      "name": "cria_ou_atualiza_contato_na_clint1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2620,
        280
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "Nome do Cliente",
              "value": "={{ $json[\"body\"][\"client\"][\"name\"]\n  .split(\" \")\n  .map(name => {\n    const lowercaseWords = [\"de\", \"dos\", \"da\", \"das\", \"do\", \"ao\", \"aos\"];\n    return lowercaseWords.includes(name.toLowerCase()) ? name.toLowerCase() : name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();\n  })\n  .join(\" \")}}"
            },
            {
              "name": "E-mail do Cliente",
              "value": "={{ $json[\"body\"][\"client\"][\"email\"] }}"
            },
            {
              "name": "Telefone do Cliente",
              "value": "={{ \n  (() => {\n    const telefone = $json[\"body\"][\"client\"][\"cellphone\"];\n    if (!telefone) {\n      return '';\n    }\n    \n    const telefoneLimpo = telefone.replace(/[^\\d]/g, '');\n  \n    let ddi;\n    let ddd;\n    let telefoneFormatado;\n  \n    // Verificar se o telefone começa com \"55\" antes de formatá-lo\n    if (telefoneLimpo.startsWith('55')) {\n      ddi = telefoneLimpo.slice(0, 2);\n      ddd = telefoneLimpo.slice(2, 4);\n      if (parseInt(ddd, 10) > 28) {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-8);\n      } else {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-9);\n      }\n    } else {\n      // Se o DDI for diferente de 55, manter o número como está\n      telefoneFormatado = telefoneLimpo;\n    }\n  \n    return '+' + telefoneFormatado;\n  })() \n}}"
            },
            {
              "name": "cpf/cnpj",
              "value": "={{ $json[\"body\"][\"client\"][\"cpf_cnpj\"] }}"
            },
            {
              "name": "nome_produto",
              "value": "={{ $json[\"body\"][\"product\"][\"name\"] }}"
            },
            {
              "name": "id_transacao_checkout",
              "value": "={{ $json[\"body\"][\"sale\"][\"id\"] }}"
            },
            {
              "name": "id_produto",
              "value": "={{ $json[\"body\"][\"product\"][\"id\"] }}"
            },
            {
              "name": "valor",
              "value": "={{ $json[\"body\"][\"product\"][\"amount\"] }}"
            },
            {
              "name": "oferta",
              "value": "={{ $json[\"body\"][\"offer\"][\"hash\"] }}"
            },
            {
              "name": "forma_de_pagamento",
              "value": "={{ $json[\"body\"][\"sale\"][\"method\"] }}"
            },
            {
              "name": "status_da_compra",
              "value": "={{ $json[\"body\"][\"sale\"][\"status\"] }}"
            },
            {
              "name": "data_conversao",
              "value": "={{ $json[\"body\"][\"sale\"][\"created_at\"].slice (0,10) }}"
            },
            {
              "name": "period",
              "value": "={{ $json[\"body\"][\"product\"][\"period\"] }}"
            },
            {
              "name": "parcelas",
              "value": "={{ $json[\"body\"][\"sale\"][\"installments\"] }}"
            },
            {
              "name": "ddd",
              "value": "={{ $json[\"body\"][\"client\"][\"cellphone\"].slice (3,5) }}"
            },
            {
              "name": "cep",
              "value": "={{ $json[\"body\"][\"client\"][\"zipcode\"] }}"
            },
            {
              "name": "utm_source",
              "value": "="
            },
            {
              "name": "utm_campaign",
              "value": "="
            },
            {
              "name": "utm_medium",
              "value": "="
            },
            {
              "name": "utm_content",
              "value": "="
            },
            {
              "name": "utm_term",
              "value": "="
            },
            {
              "name": "comissao_gateway",
              "value": "={{ $json[\"body\"][\"sale\"][\"fee\"] }}"
            },
            {
              "name": "data_conversao",
              "value": "={{ $json[\"body\"][\"sale\"][\"updated_at\"] ? $json[\"body\"][\"sale\"][\"updated_at\"].slice(8,10) + '/' + $json[\"body\"][\"sale\"][\"updated_at\"].slice(5,7) + '/' + $json[\"body\"][\"sale\"][\"updated_at\"].slice(0,4) + ' ' + $json[\"body\"][\"sale\"][\"updated_at\"].slice(11,16) : ''}}"
            },
            {
              "name": "client_id",
              "value": "={{ $json[\"body\"][\"sale\"][\"client_id\"] }}"
            },
            {
              "name": "seller_balance",
              "value": "={{ $json[\"body\"][\"sale\"][\"seller_balance\"] }}"
            },
            {
              "name": "data_garantia",
              "value": "={{ \n  (() => {\n    const updatedAt = $json[\"body\"][\"sale\"][\"updated_at\"];\n    if (!updatedAt) {\n      return '';\n    }\n    \n    const dateObj = new Date(updatedAt);\n    const daysToAdd = 7; // ou -7 para subtrair\n    const newDate = new Date(dateObj);\n    newDate.setDate(newDate.getDate() + daysToAdd);\n    return newDate.toLocaleDateString('pt-BR');\n  })() \n}}"
            },
            {
              "name": "code_pix",
              "value": "={{ $json[\"body\"][\"sale\"][\"qrcode\"] }}"
            },
            {
              "name": "qrcode_pix",
              "value": "={{ $json[\"body\"][\"sale\"][\"imgQrcode\"] }}"
            },
            {
              "name": "form_id",
              "value": "register-with-plan-popup"
            },
            {
              "name": "zipcode",
              "value": "={{ $json[\"body\"][\"client\"][\"zipcode\"] }}"
            },
            {
              "name": "street",
              "value": "={{ $json[\"body\"][\"client\"][\"street\"] }}"
            },
            {
              "name": "number",
              "value": "={{ $json[\"body\"][\"client\"][\"number\"] }}"
            },
            {
              "name": "complement",
              "value": "={{ $json[\"body\"][\"client\"][\"complement\"] }}"
            },
            {
              "name": "neighborhood",
              "value": "={{ $json[\"body\"][\"client\"][\"neighborhood\"] }}"
            },
            {
              "name": "city",
              "value": "={{ $json[\"body\"][\"client\"][\"city\"] }}"
            },
            {
              "name": "uf",
              "value": "={{ $json[\"body\"][\"client\"][\"uf\"] }}"
            },
            {
              "name": "cpf_cnpj",
              "value": "={{ $json[\"body\"][\"client\"][\"cpf_cnpj\"] }}"
            },
            {
              "name": "Telefone do Cliente - Formato Z-API",
              "value": "={{ \n  (() => {\n    const telefone = $json[\"body\"][\"client\"][\"cellphone\"];\n    if (!telefone) {\n      return '';\n    }\n    \n    const telefoneLimpo = telefone.replace(/[^\\d]/g, '');\n  \n    let ddi;\n    let ddd;\n    let telefoneFormatado;\n  \n    // Verificar se o telefone começa com \"55\" antes de formatá-lo\n    if (telefoneLimpo.startsWith('55')) {\n      ddi = telefoneLimpo.slice(0, 2);\n      ddd = telefoneLimpo.slice(2, 4);\n      if (parseInt(ddd, 10) > 28) {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-8);\n      } else {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-9);\n      }\n    } else {\n      // Se o DDI for diferente de 55, manter o número como está\n      telefoneFormatado = telefoneLimpo;\n    }\n  \n    return telefoneFormatado;\n  })() \n}}"
            },
            {
              "name": "API-KEY",
              "value": "082a2a5d-d695-4550-8b86-a9d9b703e248"
            },
            {
              "name": "id_campo_email_da_compra_bot_conversa",
              "value": "1079928"
            },
            {
              "name": "id_campo_cpf_cnpj_bot_conversa",
              "value": "976438"
            },
            {
              "name": "id_campo_id_da_transacao_bot_conversa",
              "value": "1079931"
            },
            {
              "name": "id_fluxo_compra_aprovada"
            },
            {
              "name": "id_campo_link_pagamento_pix_bot_conversa",
              "value": "976440"
            },
            {
              "name": "id_campo_link_pagamento_boleto_bot_conversa",
              "value": "976442"
            },
            {
              "name": "id_campo_linha_digitavel_boleto_bot_conversa",
              "value": "976443"
            },
            {
              "name": "id_campo_linha_digitavel_pix_bot_conversa",
              "value": "976441"
            },
            {
              "name": "moeda",
              "value": "BRL"
            },
            {
              "name": "id_campo_id_da_compra_bot_conversa",
              "value": "1079931"
            },
            {
              "name": "link_pagamento_boleto",
              "value": "={{ $json[\"body\"][\"sale\"][\"boleto_url\"] }}"
            },
            {
              "name": "link_pagamento_pix",
              "value": "={{ $json[\"body\"][\"sale\"][\"qrcode\"] }}"
            },
            {
              "name": "id_campo_id_banco_de_dados_bot_conversa",
              "value": "1375549"
            },
            {
              "name": "id_campo_utm_content_bot_conversa",
              "value": "1146799"
            },
            {
              "name": "id_campo_utm_term_bot_conversa",
              "value": "1146796"
            },
            {
              "name": "id_campo_utm_campaign_bot_conversa",
              "value": "1146800"
            },
            {
              "name": "id_campo_utm_source_bot_conversa",
              "value": "1146795"
            },
            {
              "name": "id_campo_utm_medium_bot_conversa",
              "value": "1146797"
            },
            {
              "name": "linha_digitavel_boleto_bot_conversa",
              "value": "={{ $json[\"body\"][\"sale\"][\"boleto_barcode\"] }}"
            },
            {
              "name": "linha_digitavel_pix_bot_conversa",
              "value": "={{ $json[\"body\"][\"sale\"][\"qrcode\"] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "d036882a-e430-4643-b077-12e1fdd25f81",
      "name": "dados_da_compra2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        780,
        280
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CALL busca_conversao(\n  '{{ $node[\"formata_dados1\"].json[\"id_transacao_checkout\"] }}',\n  '{{ $node[\"cria_atualiza_user\"].json[\"id\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"client_id\"] }}',\n  '{{ $node[\"busca_funil\"].json[\"id_funil\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"id_produto\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"valor\"] }}',\n  {{ $node[\"formata_dados1\"].json[\"parcelas\"] ? $node[\"formata_dados1\"].json[\"parcelas\"] : null }},\n  '{{ $node[\"formata_dados1\"].json[\"oferta\"] ? $node[\"formata_dados1\"].json[\"oferta\"] : null }}',\n  '{{ $node[\"formata_dados1\"].json[\"comissao_gateway\"] }}',\n  {{ $node[\"formata_dados1\"].json[\"id_vendedor\"] ? $node[\"formata_dados1\"].json[\"id_vendedor\"] : null }},\n  '{{ $node[\"formata_dados1\"].json[\"moeda\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"forma_de_pagamento\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"status_da_compra\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"data_conversao\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"utm_source\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"utm_campaign\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"utm_term\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"utm_medium\"] }}',\n  '{{ $node[\"formata_dados1\"].json[\"utm_content\"] }}'\n);\n",
        "options": {
          "detailedOutput": false
        }
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        2220,
        280
      ],
      "id": "4e62f3d2-cb1e-4aeb-a02a-2a1a967973d3",
      "name": "executa_procedure1",
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        2400,
        280
      ],
      "id": "346d6073-5f1f-4e77-ac9e-16750b72c85a",
      "name": "Limit1"
    },
    {
      "parameters": {
        "jsCode": "// ===== FORMATA DADOS — igual ao anterior, mas \"data_garantia\" agora é DATE (yyyy-MM-dd) =====\n\nconst root = items[0]?.json ?? {};\nconst payload = Array.isArray(root) ? (root[0] ?? {}) : (root.body ?? root);\n\nfunction capitalizeName(fullName) {\n  if (!fullName) return { fname: '', lname: '', fullname: '' };\n  const lowers = ['da','de','do','di','du'];\n  const parts = String(fullName).toLowerCase().split(/\\s+/).filter(Boolean)\n    .map((w,i) => (lowers.includes(w) && i !== 0) ? w : w.charAt(0).toUpperCase() + w.slice(1));\n  const fname = parts.shift() || '';\n  const lname = parts.join(' ');\n  return { fname, lname, fullname: `${fname}${lname ? ' ' + lname : ''}`.trim() };\n}\nfunction toZapiPhone(v){\n  if (!v) return '';\n  const raw = String(v).replace(/\\D/g,'');\n  const noDDI = raw.startsWith('55') ? raw.slice(2) : raw;\n  const ddd = noDDI.slice(0,2);\n  let num = noDDI.slice(2);\n  if (num.length >= 9) num = num.slice(-9);\n  else if (num.length === 8) num = num.slice(-8);\n  return `55${ddd}${num}`;\n}\nfunction fmtEmail(e){ return e ? String(e).toLowerCase().trim() : ''; }\n\n// ➜ Formata data/hora BR para TIMESTAMP ISO (com -3h)\nfunction fmtDateBRToISO(dt) {\n  if (!dt) return '';\n  const s = String(dt).trim();\n  let m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})\\s+(\\d{2}):(\\d{2})(?::(\\d{2}))?$/);\n  if (m) {\n    const [, d, mo, y, h, mi, ss] = m;\n    const date = new Date(`${y}-${mo}-${d}T${h}:${mi}:${ss ?? '00'}Z`);\n    date.setHours(date.getHours() - 0);\n    const yyyy = date.getFullYear();\n    const mm = String(date.getMonth() + 1).padStart(2, \"0\");\n    const dd = String(date.getDate()).padStart(2, \"0\");\n    const HH = String(date.getHours()).padStart(2, \"0\");\n    const II = String(date.getMinutes()).padStart(2, \"0\");\n    const SS = String(date.getSeconds()).padStart(2, \"0\");\n    return `${yyyy}-${mm}-${dd} ${HH}:${II}:${SS}`;\n  }\n  m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})$/);\n  if (m) {\n    const [, d, mo, y] = m;\n    return `${y}-${mo}-${d} 00:00:00`;\n  }\n  return '';\n}\n\n// ➜ Apenas DATE (yyyy-MM-dd)\nfunction fmtDateBRToISODate(dt) {\n  if (!dt) return '';\n  const s = String(dt).trim();\n  const m = s.match(/^(\\d{2})\\/(\\d{2})\\/(\\d{4})(?:\\s+\\d{2}:\\d{2}(?::\\d{2})?)?$/);\n  if (!m) return '';\n  const [, d, mo, y] = m;\n  return `${y}-${mo}-${d}`;\n}\n\n// ✅ Ajustado: agora \"paid\" = \"Compra Aprovada\"\nfunction mapStatus(s){\n  if (!s) return '';\n  if (s === 'waiting_payment') return 'Aguardando Pagamento';\n  if (s === 'paid') return 'Compra Aprovada';\n  return s;\n}\n\nfunction numOrNull(v){ const n = Number(v); return Number.isFinite(n) ? n : null; }\nfunction strOrEmpty(v){ return v == null ? '' : String(v); }\n\nconst nomeCliente   = payload['Nome do Cliente'] ?? '';\nconst emailCliente  = payload['E-mail do Cliente'] ?? '';\nconst telCliente    = payload['Telefone do Cliente'] ?? '';\nconst cpfcnpj       = payload['cpf/cnpj'] ?? '';\nconst nomeProduto   = payload['nome_produto'] ?? '';\n\nconst idTransacao   = payload['id_transacao_checkout'];\nconst idProduto     = payload['id_produto'];\nconst valor         = payload['valor'];\nconst oferta        = payload['oferta'] ?? '';\nconst formaPgto     = payload['forma_de_pagamento'] ?? '';\nconst statusCompra  = payload['status_da_compra'] ?? '';\nconst dataConvBR    = payload['data_conversao'] ?? '';\nconst period        = payload['period'];\nconst parcelas      = payload['parcelas'];\nconst ddd           = payload['ddd'] ?? '';\nconst cep           = payload['cep'];\n\nconst utm_source    = payload['utm_source'] ?? '';\nconst utm_campaign  = payload['utm_campaign'] ?? '';\nconst utm_medium    = payload['utm_medium'] ?? '';\nconst utm_content   = payload['utm_content'] ?? '';\nconst utm_term      = payload['utm_term'] ?? '';\n\nconst comissaoGw    = payload['comissao_gateway'];\nconst clientId      = payload['client_id'];\nconst sellerBalance = payload['seller_balance'];\nconst dataGarantiaBR= payload['data_garantia'] ?? '';\nconst codePix       = payload['code_pix'] ?? '';\nconst qrcodePix     = payload['qrcode_pix'] ?? '';\nconst moeda         = payload['moeda'] ?? '';\nconst linkPagamentoBoleto = payload['link_pagamento_boleto'] ?? '';\n\nconst { fname, lname, fullname } = capitalizeName(nomeCliente);\nconst emailFmt      = fmtEmail(emailCliente);\nconst whatsappZapi  = toZapiPhone(telCliente);\nconst dataConversao = fmtDateBRToISO(dataConvBR);\nconst dataGarantia  = fmtDateBRToISODate(dataGarantiaBR);\nconst statusFmt     = mapStatus(statusCompra);\n\nconst out = {\n  fname, lname, fullname,\n  email: emailFmt,\n  whatsapp: whatsappZapi,\n\n  \"Nome do Cliente\": fullname || strOrEmpty(nomeCliente),\n  \"E-mail do Cliente\": emailFmt,\n  \"Telefone do Cliente\": strOrEmpty(telCliente),\n  \"cpf/cnpj\": strOrEmpty(cpfcnpj),\n  \"nome_produto\": strOrEmpty(nomeProduto),\n\n  \"id_transacao_checkout\": numOrNull(idTransacao),\n  \"id_produto\": numOrNull(idProduto),\n  \"valor\": numOrNull(valor),\n  \"oferta\": strOrEmpty(oferta),\n  \"forma_de_pagamento\": strOrEmpty(formaPgto),\n  \"status_da_compra\": statusFmt, // ✅ agora retorna \"Compra Aprovada\" se for \"paid\"\n  \"data_conversao\": dataConversao,\n  \"period\": numOrNull(period),\n  \"parcelas\": numOrNull(parcelas),\n  \"ddd\": strOrEmpty(ddd),\n  \"cep\": (cep === null ? null : strOrEmpty(cep)),\n\n  \"utm_source\": strOrEmpty(utm_source),\n  \"utm_campaign\": strOrEmpty(utm_campaign),\n  \"utm_medium\": strOrEmpty(utm_medium),\n  \"utm_content\": strOrEmpty(utm_content),\n  \"utm_term\": strOrEmpty(utm_term),\n\n  \"comissao_gateway\": numOrNull(comissaoGw),\n  \"client_id\": numOrNull(clientId),\n  \"seller_balance\": numOrNull(sellerBalance),\n  \"data_garantia\": dataGarantia, \n  \"code_pix\": strOrEmpty(codePix),\n  \"qrcode_pix\": strOrEmpty(qrcodePix),\n  \"moeda\": strOrEmpty(moeda),\n  \"link_pagamento_boleto\": strOrEmpty(linkPagamentoBoleto)\n};\n\nreturn [{ json: out }];\n"
      },
      "id": "2ba99600-697e-421a-9fb9-26b67c578e1c",
      "name": "formata_dados2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [
        980,
        40
      ]
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Rotacionamento de Colaboradores"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "7d5d72a7-7455-4484-9145-9cc0f9c167bf",
      "name": "pesquisa_url_rotacionamento_colaboradores2",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1580,
        40
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Users"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "5f671fa9-7c1a-4ecc-8543-1112f800ef6d",
      "name": "pesquisa_variavel_n8n_fluxo_users2",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1800,
        40
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_users2\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados2\"].json[\"fname\"] || \"\" }}"
            },
            {
              "name": "sobrenome",
              "value": "={{ $node[\"formata_dados2\"].json[\"lname\"] || \"\" }}"
            },
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados2\"].json[\"email\"] || \"\" }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados2\"].json[\"whatsapp\"] || \"\" }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2000,
        40
      ],
      "id": "ea3012b9-f95d-4f8b-b6d6-bff6a1790c56",
      "name": "cria_atualiza_user2"
    },
    {
      "parameters": {
        "url": "={{ $node[\"pesquisa_variavel_n8n_fluxo_funis2\"].json[\"valor_variavel\"] }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "id_forms",
              "value": "={{ $node[\"dados_da_compra3\"].json[\"form_id\"] }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1380,
        40
      ],
      "id": "5ca4c177-5d05-42d5-a391-0e12f8cb362c",
      "name": "busca_funil2"
    },
    {
      "parameters": {
        "operation": "select",
        "table": {
          "__rl": true,
          "value": "variaveis_globais_n8n",
          "mode": "list",
          "cachedResultName": "variaveis_globais_n8n"
        },
        "where": {
          "values": [
            {
              "column": "nome_variavel",
              "value": "URL do Fluxo de Verificação de Funis"
            }
          ]
        },
        "combineConditions": "OR",
        "options": {}
      },
      "id": "1563a62d-e5e0-461c-bd7c-ade2138d3c35",
      "name": "pesquisa_variavel_n8n_fluxo_funis2",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        1200,
        40
      ],
      "alwaysOutputData": true,
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://functions-api.clint.digital/endpoints/integration/webhook/3353fe0c-b7cd-4b73-83aa-7709536c609b",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "email",
              "value": "={{ $node[\"formata_dados2\"].json[\"E-mail do Cliente\"] }}"
            },
            {
              "name": "nome",
              "value": "={{ $node[\"formata_dados2\"].json[\"Nome do Cliente\"] }}"
            },
            {
              "name": "telefone",
              "value": "={{ $node[\"formata_dados2\"].json[\"whatsapp\"] }}"
            },
            {
              "name": "cpf/cnpj",
              "value": "={{ $node[\"formata_dados2\"].json[\"cpf/cnpj\"] }}"
            },
            {
              "name": "produto",
              "value": "={{ $node[\"formata_dados2\"].json[\"nome_produto\"] }}"
            },
            {
              "name": "metodo_pagamento",
              "value": "={{ $node[\"formata_dados2\"].json[\"forma_de_pagamento\"] }}"
            },
            {
              "name": "parcelas",
              "value": "={{ $node[\"formata_dados2\"].json[\"parcelas\"] }}"
            },
            {
              "name": "valor",
              "value": "={{ $node[\"formata_dados2\"].json[\"valor\"] }}"
            },
            {
              "name": "Plataforma",
              "value": "Green"
            },
            {
              "name": "status_da_compra",
              "value": "={{ $node[\"formata_dados2\"].json[\"status_da_compra\"] }}"
            },
            {
              "name": "data_conversao",
              "value": "={{ $node[\"formata_dados2\"].json[\"data_conversao\"] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e4f69adb-8cc4-4908-8f5b-4c187bdd89ec",
      "name": "cria_ou_atualiza_contato_na_clint",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2620,
        40
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "Nome do Cliente",
              "value": "={{ $json[\"body\"][\"client\"][\"name\"]\n  .split(\" \")\n  .map(name => {\n    const lowercaseWords = [\"de\", \"dos\", \"da\", \"das\", \"do\", \"ao\", \"aos\"];\n    return lowercaseWords.includes(name.toLowerCase()) ? name.toLowerCase() : name.charAt(0).toUpperCase() + name.slice(1).toLowerCase();\n  })\n  .join(\" \")}}"
            },
            {
              "name": "E-mail do Cliente",
              "value": "={{ $json[\"body\"][\"client\"][\"email\"] }}"
            },
            {
              "name": "Telefone do Cliente",
              "value": "={{ \n  (() => {\n    const telefone = $json[\"body\"][\"client\"][\"cellphone\"];\n    if (!telefone) {\n      return '';\n    }\n    \n    const telefoneLimpo = telefone.replace(/[^\\d]/g, '');\n  \n    let ddi;\n    let ddd;\n    let telefoneFormatado;\n  \n    // Verificar se o telefone começa com \"55\" antes de formatá-lo\n    if (telefoneLimpo.startsWith('55')) {\n      ddi = telefoneLimpo.slice(0, 2);\n      ddd = telefoneLimpo.slice(2, 4);\n      if (parseInt(ddd, 10) > 28) {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-8);\n      } else {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-9);\n      }\n    } else {\n      // Se o DDI for diferente de 55, manter o número como está\n      telefoneFormatado = telefoneLimpo;\n    }\n  \n    return '+' + telefoneFormatado;\n  })() \n}}"
            },
            {
              "name": "cpf/cnpj",
              "value": "={{ $json[\"body\"][\"client\"][\"cpf_cnpj\"] }}"
            },
            {
              "name": "nome_produto",
              "value": "={{ $json[\"body\"][\"product\"][\"name\"] }}"
            },
            {
              "name": "id_transacao_checkout",
              "value": "={{ $json[\"body\"][\"sale\"][\"id\"] }}"
            },
            {
              "name": "id_produto",
              "value": "={{ $json[\"body\"][\"product\"][\"id\"] }}"
            },
            {
              "name": "valor",
              "value": "={{ $json[\"body\"][\"product\"][\"amount\"] }}"
            },
            {
              "name": "oferta",
              "value": "={{ $json[\"body\"][\"offer\"][\"hash\"] }}"
            },
            {
              "name": "forma_de_pagamento",
              "value": "={{ $json[\"body\"][\"sale\"][\"method\"] }}"
            },
            {
              "name": "status_da_compra",
              "value": "={{ $json[\"body\"][\"sale\"][\"status\"] }}"
            },
            {
              "name": "data_conversao",
              "value": "={{ $json[\"body\"][\"sale\"][\"created_at\"].slice (0,10) }}"
            },
            {
              "name": "period",
              "value": "={{ $json[\"body\"][\"product\"][\"period\"] }}"
            },
            {
              "name": "parcelas",
              "value": "={{ $json[\"body\"][\"sale\"][\"installments\"] }}"
            },
            {
              "name": "ddd",
              "value": "={{ $json[\"body\"][\"client\"][\"cellphone\"].slice (3,5) }}"
            },
            {
              "name": "cep",
              "value": "={{ $json[\"body\"][\"client\"][\"zipcode\"] }}"
            },
            {
              "name": "utm_source",
              "value": "="
            },
            {
              "name": "utm_campaign",
              "value": "="
            },
            {
              "name": "utm_medium",
              "value": "="
            },
            {
              "name": "utm_content",
              "value": "="
            },
            {
              "name": "utm_term",
              "value": "="
            },
            {
              "name": "comissao_gateway",
              "value": "={{ $json[\"body\"][\"sale\"][\"fee\"] }}"
            },
            {
              "name": "data_conversao",
              "value": "={{ $json[\"body\"][\"sale\"][\"updated_at\"] ? $json[\"body\"][\"sale\"][\"updated_at\"].slice(8,10) + '/' + $json[\"body\"][\"sale\"][\"updated_at\"].slice(5,7) + '/' + $json[\"body\"][\"sale\"][\"updated_at\"].slice(0,4) + ' ' + $json[\"body\"][\"sale\"][\"updated_at\"].slice(11,16) : ''}}"
            },
            {
              "name": "client_id",
              "value": "={{ $json[\"body\"][\"sale\"][\"client_id\"] }}"
            },
            {
              "name": "seller_balance",
              "value": "={{ $json[\"body\"][\"sale\"][\"seller_balance\"] }}"
            },
            {
              "name": "data_garantia",
              "value": "={{ \n  (() => {\n    const updatedAt = $json[\"body\"][\"sale\"][\"updated_at\"];\n    if (!updatedAt) {\n      return '';\n    }\n    \n    const dateObj = new Date(updatedAt);\n    const daysToAdd = 7; // ou -7 para subtrair\n    const newDate = new Date(dateObj);\n    newDate.setDate(newDate.getDate() + daysToAdd);\n    return newDate.toLocaleDateString('pt-BR');\n  })() \n}}"
            },
            {
              "name": "code_pix",
              "value": "={{ $json[\"body\"][\"sale\"][\"qrcode\"] }}"
            },
            {
              "name": "qrcode_pix",
              "value": "={{ $json[\"body\"][\"sale\"][\"imgQrcode\"] }}"
            },
            {
              "name": "form_id",
              "value": "register-with-plan-popup"
            },
            {
              "name": "zipcode",
              "value": "={{ $json[\"body\"][\"client\"][\"zipcode\"] }}"
            },
            {
              "name": "street",
              "value": "={{ $json[\"body\"][\"client\"][\"street\"] }}"
            },
            {
              "name": "number",
              "value": "={{ $json[\"body\"][\"client\"][\"number\"] }}"
            },
            {
              "name": "complement",
              "value": "={{ $json[\"body\"][\"client\"][\"complement\"] }}"
            },
            {
              "name": "neighborhood",
              "value": "={{ $json[\"body\"][\"client\"][\"neighborhood\"] }}"
            },
            {
              "name": "city",
              "value": "={{ $json[\"body\"][\"client\"][\"city\"] }}"
            },
            {
              "name": "uf",
              "value": "={{ $json[\"body\"][\"client\"][\"uf\"] }}"
            },
            {
              "name": "cpf_cnpj",
              "value": "={{ $json[\"body\"][\"client\"][\"cpf_cnpj\"] }}"
            },
            {
              "name": "Telefone do Cliente - Formato Z-API",
              "value": "={{ \n  (() => {\n    const telefone = $json[\"body\"][\"client\"][\"cellphone\"];\n    if (!telefone) {\n      return '';\n    }\n    \n    const telefoneLimpo = telefone.replace(/[^\\d]/g, '');\n  \n    let ddi;\n    let ddd;\n    let telefoneFormatado;\n  \n    // Verificar se o telefone começa com \"55\" antes de formatá-lo\n    if (telefoneLimpo.startsWith('55')) {\n      ddi = telefoneLimpo.slice(0, 2);\n      ddd = telefoneLimpo.slice(2, 4);\n      if (parseInt(ddd, 10) > 28) {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-8);\n      } else {\n        telefoneFormatado = ddi + ddd + telefoneLimpo.slice(-9);\n      }\n    } else {\n      // Se o DDI for diferente de 55, manter o número como está\n      telefoneFormatado = telefoneLimpo;\n    }\n  \n    return telefoneFormatado;\n  })() \n}}"
            },
            {
              "name": "API-KEY",
              "value": "082a2a5d-d695-4550-8b86-a9d9b703e248"
            },
            {
              "name": "id_campo_email_da_compra_bot_conversa",
              "value": "1079928"
            },
            {
              "name": "id_campo_cpf_cnpj_bot_conversa",
              "value": "976438"
            },
            {
              "name": "id_campo_id_da_transacao_bot_conversa",
              "value": "1079931"
            },
            {
              "name": "id_fluxo_compra_aprovada"
            },
            {
              "name": "id_campo_link_pagamento_pix_bot_conversa",
              "value": "976440"
            },
            {
              "name": "id_campo_link_pagamento_boleto_bot_conversa",
              "value": "976442"
            },
            {
              "name": "id_campo_linha_digitavel_boleto_bot_conversa",
              "value": "976443"
            },
            {
              "name": "id_campo_linha_digitavel_pix_bot_conversa",
              "value": "976441"
            },
            {
              "name": "moeda",
              "value": "BRL"
            },
            {
              "name": "id_campo_id_da_compra_bot_conversa",
              "value": "1079931"
            },
            {
              "name": "link_pagamento_boleto",
              "value": "={{ $json[\"body\"][\"sale\"][\"boleto_url\"] }}"
            },
            {
              "name": "link_pagamento_pix",
              "value": "={{ $json[\"body\"][\"sale\"][\"qrcode\"] }}"
            },
            {
              "name": "id_campo_id_banco_de_dados_bot_conversa",
              "value": "1375549"
            },
            {
              "name": "id_campo_utm_content_bot_conversa",
              "value": "1146799"
            },
            {
              "name": "id_campo_utm_term_bot_conversa",
              "value": "1146796"
            },
            {
              "name": "id_campo_utm_campaign_bot_conversa",
              "value": "1146800"
            },
            {
              "name": "id_campo_utm_source_bot_conversa",
              "value": "1146795"
            },
            {
              "name": "id_campo_utm_medium_bot_conversa",
              "value": "1146797"
            },
            {
              "name": "linha_digitavel_boleto_bot_conversa",
              "value": "={{ $json[\"body\"][\"sale\"][\"boleto_barcode\"] }}"
            },
            {
              "name": "linha_digitavel_pix_bot_conversa",
              "value": "={{ $json[\"body\"][\"sale\"][\"qrcode\"] }}"
            }
          ]
        },
        "options": {}
      },
      "id": "5a81ec36-909b-4e8b-8c40-f2200df70a29",
      "name": "dados_da_compra3",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        780,
        40
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CALL busca_conversao(\n  '{{ $node[\"formata_dados2\"].json[\"id_transacao_checkout\"] }}',\n  '{{ $node[\"cria_atualiza_user2\"].json[\"id\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"client_id\"] }}',\n  '{{ $node[\"busca_funil2\"].json[\"id_funil\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"id_produto\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"valor\"] }}',\n  {{ $node[\"formata_dados2\"].json[\"parcelas\"] ? $node[\"formata_dados2\"].json[\"parcelas\"] : null }},\n  '{{ $node[\"formata_dados2\"].json[\"oferta\"] ? $node[\"formata_dados2\"].json[\"oferta\"] : null }}',\n  '{{ $node[\"formata_dados2\"].json[\"comissao_gateway\"] }}',\n  {{ $node[\"formata_dados2\"].json[\"id_vendedor\"] ? $node[\"formata_dados1\"].json[\"id_vendedor\"] : null }},\n  '{{ $node[\"formata_dados2\"].json[\"moeda\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"forma_de_pagamento\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"status_da_compra\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"data_conversao\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"utm_source\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"utm_campaign\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"utm_term\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"utm_medium\"] }}',\n  '{{ $node[\"formata_dados2\"].json[\"utm_content\"] }}'\n);\n",
        "options": {
          "detailedOutput": false
        }
      },
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 2.4,
      "position": [
        2220,
        40
      ],
      "id": "72d21ef8-3124-4500-a53e-2506af847fa3",
      "name": "executa_procedure2",
      "credentials": {
        "mySql": {
          "id": "PfzfhyuSKTUfroef",
          "name": "[MySQL] - Fabricio Nunnes"
        }
      }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        2400,
        40
      ],
      "id": "cc2df237-afea-4ae3-8991-005a4d88c39f",
      "name": "Limit2"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "aguardando_pagamento-dci",
        "options": {}
      },
      "id": "5387b80a-583a-4f1d-80d3-78f89eb2db8f",
      "name": "aguardando_pagamento",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        580,
        280
      ],
      "webhookId": "1332482d-357e-4030-9e54-291af4ebb423"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "compra-aprovada-dci",
        "options": {}
      },
      "id": "c3628ab9-2e0b-473c-ab2f-dbdb475d51fd",
      "name": "compra_aprovada",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        580,
        40
      ],
      "webhookId": "1332482d-357e-4030-9e54-291af4ebb423"
    }
  ],
  "pinData": {
    "aguardando_pagamento": [
      {
        "json": {
          "headers": {
            "host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "user-agent": "GuzzleHttp/7",
            "content-length": "3300",
            "content-type": "application/json",
            "x-forwarded-for": "54.208.146.185",
            "x-forwarded-host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "77400aba3c69",
            "x-real-ip": "54.208.146.185",
            "x-webhook-token": "$2y$10$/8k7L/hFRqGr6eVYx4XDIerpK3oBt9LpG6ZauoFcWFY8Wx7lxY7cC",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "type": "sale",
            "event": "saleUpdated",
            "oldStatus": "waiting_payment",
            "currentStatus": "waiting_payment",
            "sale": {
              "id": 6672145,
              "type": "SUBSCRIPTION",
              "status": "waiting_payment",
              "created_at": "2025-10-01T19:55:26.000000Z",
              "updated_at": "2025-10-01T19:55:30.000000Z",
              "seller_id": 33571,
              "installments": 1,
              "method": "BOLETO",
              "client_id": 4245172,
              "fee": 0,
              "seller_balance": 0,
              "total": 0,
              "amount": 297,
              "proposal_id": null,
              "subscription_id": "sub_68dd872f1f4114blt18el5xp",
              "boleto_url": "https://adm.greenn.com.br/redirect/s7zGxIfT9j",
              "boleto_barcode": "19790000056215343156434305377284212210000029700",
              "boleto_expiration_date": "2025-10-01",
              "qrcode": null,
              "imgQrcode": null,
              "paid_at": null,
              "bump_id": null,
              "is_smart_sale": 0,
              "shipping_amount": null,
              "shipping_selected": null,
              "coupon": null
            },
            "client": {
              "id": 4245172,
              "name": "Jose Teste Silva",
              "email": "joseteste@gmail.com",
              "cellphone": "+5531955443322",
              "document": "373.208.890-13",
              "zipcode": null,
              "street": "",
              "number": "",
              "complement": "",
              "neighborhood": "",
              "city": "",
              "uf": "",
              "created_at": "2025-10-01T19:55:26.000000Z",
              "updated_at": "2025-10-01T19:55:26.000000Z",
              "document_type": "cpf",
              "cpf_cnpj": "373.208.890-13"
            },
            "product": {
              "id": 137613,
              "name": "Diretor Comercial Inteligente - 10 usuários",
              "description": "Sistema completo com 4 IAs especializadas: Comercial, Marketing, Social Media e Financeiro trabalhando 24/7 pela sua empresa.\nEnquanto seus concorrentes ainda fazem planilhas, você terá 4 IAs especializadas trabalhando 24/7 para otimizar seus resultados.",
              "type": "SUBSCRIPTION",
              "amount": 297,
              "period": 30,
              "thank_you_page": "http://diretor.universidadevendas.com.br/login",
              "created_at": "2025-09-24T18:04:22.000000Z",
              "updated_at": "2025-09-26T17:01:09.000000Z",
              "method": "CREDIT_CARD,BOLETO,PIX",
              "url_callback": null,
              "trial": 0,
              "proposal_minimum": 0,
              "allow_proposal": 0,
              "affiliation_approbation": 1,
              "affiliation_public": 1,
              "is_active": 1,
              "deleted_at": null,
              "affiliation_proposal": 1,
              "category_fiscal": "SERVICE",
              "fiscal_code": null
            },
            "oferta": "Diretor Comercial Inteligente - 10 usuários",
            "offer": {
              "hash": "np9b0M",
              "amount": 297,
              "method": "CREDIT_CARD,BOLETO,PIX",
              "name": "Diretor Comercial Inteligente - 10 usuários",
              "created_at": "2025-09-24T18:04:22.000000Z"
            },
            "seller": {
              "id": 33571,
              "name": "Fabricio Augusto Nunes Oliveira",
              "email": "fabricioaugustonoliveira@gmail.com",
              "cellphone": "+5531989840003"
            },
            "affiliate": null,
            "productMetas": [],
            "proposalMetas": [],
            "saleMetas": [
              {
                "id": 37106285,
                "sale_id": 6672145,
                "meta_key": "reuse_credit_card",
                "meta_value": "1",
                "created_at": "2025-10-01T19:55:26.000000Z",
                "updated_at": "2025-10-01T19:55:26.000000Z"
              },
              {
                "id": 37106286,
                "sale_id": 6672145,
                "meta_key": "assoc_ticket",
                "meta_value": "0",
                "created_at": "2025-10-01T19:55:26.000000Z",
                "updated_at": "2025-10-01T19:55:26.000000Z"
              },
              {
                "id": 37106287,
                "sale_id": 6672145,
                "meta_key": "utm_source",
                "meta_value": "typeform?em=joseteste@gmail.com",
                "created_at": "2025-10-01T19:55:26.000000Z",
                "updated_at": "2025-10-01T19:55:26.000000Z"
              },
              {
                "id": 37106288,
                "sale_id": 6672145,
                "meta_key": "fn",
                "meta_value": "Jose Teste Silva",
                "created_at": "2025-10-01T19:55:26.000000Z",
                "updated_at": "2025-10-01T19:55:26.000000Z"
              },
              {
                "id": 37106289,
                "sale_id": 6672145,
                "meta_key": "ph",
                "meta_value": "31955443322",
                "created_at": "2025-10-01T19:55:26.000000Z",
                "updated_at": "2025-10-01T19:55:26.000000Z"
              }
            ],
            "sf_trk": null,
            "client_has_contract_id": 428545,
            "charge": 0
          },
          "webhookUrl": "https://webhookeditorhetznerfabricionunnes.automagicbots.com.br/webhook/aguardando_pagamento-dci",
          "executionMode": "production"
        }
      }
    ],
    "compra_aprovada": [
      {
        "json": {
          "headers": {
            "host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "user-agent": "GuzzleHttp/7",
            "content-length": "3786",
            "content-type": "application/json",
            "x-forwarded-for": "54.208.146.185",
            "x-forwarded-host": "webhookeditorhetznerfabricionunnes.automagicbots.com.br",
            "x-forwarded-port": "443",
            "x-forwarded-proto": "https",
            "x-forwarded-server": "77400aba3c69",
            "x-real-ip": "54.208.146.185",
            "x-webhook-token": "$2y$10$/8k7L/hFRqGr6eVYx4XDIerpK3oBt9LpG6ZauoFcWFY8Wx7lxY7cC",
            "accept-encoding": "gzip"
          },
          "params": {},
          "query": {},
          "body": {
            "type": "sale",
            "event": "saleUpdated",
            "oldStatus": "paid",
            "currentStatus": "paid",
            "sale": {
              "id": 6672849,
              "type": "SUBSCRIPTION",
              "status": "paid",
              "created_at": "2025-10-01T21:53:37.000000Z",
              "updated_at": "2025-10-01T22:07:01.000000Z",
              "seller_id": 33571,
              "installments": 1,
              "method": "PIX",
              "client_id": 4245750,
              "fee": 5.84,
              "seller_balance": 91.16,
              "total": 97,
              "amount": 97,
              "proposal_id": null,
              "subscription_id": "sub_68dda2e1847b1oqFkyxkOkrT",
              "boleto_url": null,
              "boleto_barcode": null,
              "boleto_expiration_date": null,
              "qrcode": "00020101021226820014br.gov.bcb.pix2560pix.stone.com.br/pix/v2/18d6e0e0-163e-4b67-9f8c-64ecec654b1c520400005303986540597.005802BR5925Pagar Me Instituicao De P6014RIO DE JANEIRO6229052512ea876c51033f14da9e169be630478C7",
              "imgQrcode": "https://api.pagar.me/core/v5/transactions/tran_Xn6WkW1TVT0BrOm2/qrcode?payment_method=pix",
              "paid_at": "2025-10-01T22:06:41.000000Z",
              "bump_id": null,
              "is_smart_sale": 0,
              "shipping_amount": null,
              "shipping_selected": null,
              "coupon": {
                "id": 51202,
                "seller_id": 33571,
                "name": "100OFF",
                "type": "AMOUNT",
                "amount": 100,
                "only_products": 0,
                "limit": null,
                "due_date": null,
                "created_at": "2025-10-01T21:52:21.000000Z",
                "updated_at": "2025-10-01T21:52:21.000000Z",
                "is_active": 1,
                "deleted_at": null,
                "currency_id": 1,
                "convert_amount": 0,
                "used": 1,
                "status": "active"
              }
            },
            "client": {
              "id": 4245750,
              "name": "Yasmim Aguiar",
              "email": "yasmimaguiarsc@gmail.com",
              "cellphone": "+5531992372507",
              "document": "078.102.716-01",
              "zipcode": null,
              "street": "",
              "number": "",
              "complement": "",
              "neighborhood": "",
              "city": "",
              "uf": "",
              "created_at": "2025-10-01T21:53:37.000000Z",
              "updated_at": "2025-10-01T21:53:37.000000Z",
              "document_type": "cpf",
              "cpf_cnpj": "078.102.716-01"
            },
            "product": {
              "id": 137612,
              "name": "Diretor Comercial Inteligente - 5 usuários",
              "description": "Sistema completo com 4 IAs especializadas: Comercial, Marketing, Social Media e Financeiro trabalhando 24/7 pela sua empresa.\nEnquanto seus concorrentes ainda fazem planilhas, você terá 4 IAs especializadas trabalhando 24/7 para otimizar seus resultados.",
              "type": "SUBSCRIPTION",
              "amount": 197,
              "period": 30,
              "thank_you_page": "http://diretor.universidadevendas.com.br/login",
              "created_at": "2025-09-24T18:02:05.000000Z",
              "updated_at": "2025-09-30T21:07:16.000000Z",
              "method": "CREDIT_CARD,BOLETO,PIX",
              "url_callback": null,
              "trial": 0,
              "proposal_minimum": 0,
              "allow_proposal": 0,
              "affiliation_approbation": 1,
              "affiliation_public": 1,
              "is_active": 1,
              "deleted_at": null,
              "affiliation_proposal": 1,
              "category_fiscal": "SERVICE",
              "fiscal_code": null
            },
            "oferta": "Diretor Comercial Inteligente - 5 usuários",
            "offer": {
              "hash": "jvVLMM",
              "amount": 197,
              "method": "CREDIT_CARD,BOLETO,PIX",
              "name": "Diretor Comercial Inteligente - 5 usuários",
              "created_at": "2025-09-24T18:02:05.000000Z"
            },
            "seller": {
              "id": 33571,
              "name": "Fabricio Augusto Nunes Oliveira",
              "email": "fabricioaugustonoliveira@gmail.com",
              "cellphone": "+5531989840003"
            },
            "affiliate": null,
            "productMetas": [],
            "proposalMetas": [],
            "saleMetas": [
              {
                "id": 37113295,
                "sale_id": 6672849,
                "meta_key": "reuse_credit_card",
                "meta_value": "1",
                "created_at": "2025-10-01T21:53:37.000000Z",
                "updated_at": "2025-10-01T21:53:37.000000Z"
              },
              {
                "id": 37113296,
                "sale_id": 6672849,
                "meta_key": "assoc_ticket",
                "meta_value": "0",
                "created_at": "2025-10-01T21:53:37.000000Z",
                "updated_at": "2025-10-01T21:53:37.000000Z"
              },
              {
                "id": 37113297,
                "sale_id": 6672849,
                "meta_key": "em",
                "meta_value": "yasmimaguiarsc@gmail.com",
                "created_at": "2025-10-01T21:53:37.000000Z",
                "updated_at": "2025-10-01T21:53:37.000000Z"
              },
              {
                "id": 37113298,
                "sale_id": 6672849,
                "meta_key": "fn",
                "meta_value": "Yasmim Aguiar",
                "created_at": "2025-10-01T21:53:37.000000Z",
                "updated_at": "2025-10-01T21:53:37.000000Z"
              },
              {
                "id": 37113299,
                "sale_id": 6672849,
                "meta_key": "ph",
                "meta_value": "31992372507",
                "created_at": "2025-10-01T21:53:37.000000Z",
                "updated_at": "2025-10-01T21:53:37.000000Z"
              }
            ],
            "sf_trk": null,
            "client_has_contract_id": 428595,
            "charge": 1
          },
          "webhookUrl": "https://webhookeditorhetznerfabricionunnes.automagicbots.com.br/webhook/compra-aprovada-dci",
          "executionMode": "production"
        }
      }
    ]
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "saveExecutionProgress": true,
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "Q8rgTKWALfDjS7MZ"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 2,
  "updatedAt": "2025-10-01T22:50:20.858Z",
  "versionId": "20262a4a-4be1-4af4-a40c-da453cd9fcfa"
}